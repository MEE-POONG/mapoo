name: CI/CD Pipeline (Diagnostic Mode)

on:
  push:
    branches: ["main", "master", "develop"]
  pull_request:
    branches: ["main", "master", "develop"]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Docker Tag to Deploy'
        required: false
        default: 'latest'

jobs:
  # 1. üß™ Test Job (Keep our good testing)
  test:
    timeout-minutes: 20
    runs-on: ubuntu-latest
    services:
      mongodb:
        image: mongo:7.0
        ports:
          - 27017:27017
        env:
          MONGO_INITDB_DATABASE: mapoo_ci
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
      - name: Install dependencies
        run: npm ci
      - name: Generate Prisma Client
        run: npx prisma generate
      - name: Next.js Lint
        run: npm run lint
      - name: Run Unit & Integration Tests
        run: npm run test -- --run
        env:
          DATABASE_URL: "mongodb://localhost:27017/mapoo_ci?replicaSet=rs0&directConnection=true"
          JWT_SECRET: "ci-test-secret"

  # 2. üê≥ Build Docker & Push
  build:
    needs: test
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Check out the repo
        uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build and Push to Docker Hub
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            chunwarayut/mapoo-shop:latest
            chunwarayut/mapoo-shop:${{ github.run_id }}
          build-args: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
          no-cache: true

  # 3. üöÄ Deploy to Server (Following your provided v2 Diagnostic pattern)
  deploy:
    needs: build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: 49.231.43.177
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            set -e
            TAG="${{ github.event.inputs.tag || github.run_id }}"
            CONTAINER_NAME="mapoo-shop-dashboard"
            IMAGE_NAME="chunwarayut/mapoo-shop"
            TARGET_PORT=7081
            
            echo "üöÄ Starting Deployment for mapoo-shop..."
            
            # 1. Pull latest image
            docker pull $IMAGE_NAME:$TAG
            
            # 2. Stop and remove existing container
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # 3. Ensure network exists (Using mapoo-network from your template)
            docker network create mapoo-network || true
            
            # 4. Run Web Application (with DNS Fix & Diagnostic Settings)
            echo "üöÄ Running container on port $TARGET_PORT..."
            docker run --name $CONTAINER_NAME \
              --label io.portainer.accesscontrol.teams=discord \
              --restart=always -d \
              -p $TARGET_PORT:3000 \
              --network kong_kong-net \
              --dns 8.8.8.8 --dns 1.1.1.1 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e ADMIN_JWT_SECRET="${{ secrets.ADMIN_JWT_SECRET }}" \
              -e ADMIN_SETUP_KEY="${{ secrets.ADMIN_SETUP_KEY }}" \
              -e LINE_NOTIFY_TOKEN="${{ secrets.LINE_NOTIFY_TOKEN }}" \
              -e SMTP_HOST="${{ secrets.SMTP_HOST }}" \
              -e SMTP_PORT="${{ secrets.SMTP_PORT }}" \
              -e SMTP_USER="${{ secrets.SMTP_USER }}" \
              -e SMTP_PASS="${{ secrets.SMTP_PASS }}" \
              -e SMTP_FROM="${{ secrets.SMTP_FROM }}" \
              -e SMTP_SECURE="${{ secrets.SMTP_SECURE }}" \
              -e NODE_ENV="production" \
              -e NODE_OPTIONS="--dns-result-order=ipv4first" \
              --memory=1024m --memory-swap=1024m --cpus=2.0 \
              --log-opt max-size=50m --log-opt max-file=3 \
              $IMAGE_NAME:$TAG
              
            # 5. Cleanup
            docker image prune -a -f
            
            # 6. Quick health check / logs
            echo "üìä Container Status:"
            docker ps | grep $CONTAINER_NAME
            
            echo "üìú Last 30 logs:"
            docker logs --tail 30 $CONTAINER_NAME
            
            echo "‚úÖ Deployment successful at http://49.231.43.177:$TARGET_PORT"
