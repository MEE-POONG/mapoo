name: CI/CD Pipeline

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  # 1. üß™ Test & Verify Code
  verify-code:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js 20
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    - name: Install dependencies
      run: npm install
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
    - name: Check Build
      run: npm run build
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NEXT_TELEMETRY_DISABLED: 1

  # 2. üê≥ Build Docker & Push
  build-push:
    needs: verify-code
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Convert repository name to lowercase
      id: string
      run: echo "lowercase=$(echo '${{ github.event.repository.name }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_TOKEN }}

    - name: Build and Push Docker Image
      uses: docker/build-push-action@v6
      with:
        context: .
        push: true
        tags: |
          chunwarayut/mapoo-shop:latest
          chunwarayut/mapoo-shop:${{ github.run_id }}
        build-args: |
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          BUILD_ID=${{ github.run_id }}
          COMMIT_SHA=${{ github.sha }}
          BUILD_TIME=${{ github.event.head_commit.timestamp }}
        no-cache: true

  # 3. üöÄ Deploy to Server
  deploy:
    needs: build-push
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: SSH Deploy
        uses: D3rHase/ssh-command-action@v0.2.2
        with:
          host: 49.231.43.177
          user: ${{ secrets.SERVER_USER }}
          private_key: ${{ secrets.SSH_KEY }}
          command: |
            set -e
            TAG="${{ github.run_id }}"
            CONTAINER_NAME="mapoo-shop-dashboard"
            IMAGE_NAME="chunwarayut/mapoo-shop"
            
            echo "üöÄ Starting Deployment for ‡∏´‡∏°‡∏π‡πÄ‡πÄ‡∏î‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß mapoo..."
            echo "üïí Time: $(date)"
            echo "‚¨áÔ∏è Pulling image with tag: $TAG"
            
            # Remove old container and image to avoid using cache
            docker stop $CONTAINER_NAME || true
            docker rm $CONTAINER_NAME || true
            
            # Pull new image
            docker pull $IMAGE_NAME:$TAG
            
            echo "üöÄ Starting new container on http://49.231.43.177:7081"
            docker run --name $CONTAINER_NAME \
              --network kong_kong-net \
              --label io.portainer.accesscontrol.teams=discord \
              --restart=always -d -p 7081:3000 \
              -e DATABASE_URL="${{ secrets.DATABASE_URL }}" \
              -e JWT_SECRET="${{ secrets.JWT_SECRET }}" \
              -e SMTP_HOST="${{ secrets.SMTP_HOST }}" \
              -e SMTP_PORT="${{ secrets.SMTP_PORT }}" \
              -e SMTP_USER="${{ secrets.SMTP_USER }}" \
              -e SMTP_PASS="${{ secrets.SMTP_PASS }}" \
              -e SMTP_FROM="${{ secrets.SMTP_FROM }}" \
              -e NODE_ENV="production" \
              --memory=1g --memory-swap=1g --cpus=1.0 \
              --log-opt max-size=10m --log-opt max-file=3 \
              $IMAGE_NAME:$TAG
            
            # Verify running
            sleep 10
            docker ps | grep $CONTAINER_NAME
            
            echo "üßπ Cleaning up old images..."
            docker image prune -a -f
            
            echo "‚úÖ Deployment successful at http://49.231.43.177:7081 with tag: $TAG"
